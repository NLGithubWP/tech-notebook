I"İ<h1 id="question">Question</h1>

<p>Does the primary need to forward reads to backups? or can we do fast reads in primary/backup replication?</p>

<p><code>No, it cause stale read problem</code></p>

<p>it is not linearizable but it is sequentially consistent.</p>

<p><img src="https://github.com/NLGithubWP/tech-notebook/raw/master/img/a_img_store/image-20220209173603528.png" alt="image-20220204230112657" /></p>

<p><code>è€ƒè™‘å¦‚ä¸‹æƒ…å†µï¼ŒAè¿ä¸ä¸Šview serverï¼Œ Bæˆäº†primaryï¼Œ client1 çŸ¥é“äº†è¿™ä¸ªç»“æœï¼Œå‘é€wåˆ°äº†Bï¼Œä½†æ˜¯client2è¿˜ä¸çŸ¥é“ï¼Œä»ç„¶å‘é€Rç»™äº†Aï¼Œ å¦‚æœAæŠŠè¯»åŒæ­¥åˆ°Bï¼ŒBä¼šå‘ç°å½“å‰çš„viewå’ŒAçš„viewä¸ä¸€è‡´ï¼Œæ‰€ä»¥æ‹’ç»ï¼ŒAæ”¶åˆ°æ‹’ç»åï¼Œè®©client retryï¼Œè¿™æ ·ä¸ä¼šæœ‰é”™è¯¯çš„ç»“æœå‘ç”Ÿã€‚</code></p>

<h1 id="basic-operation">Basic Operation</h1>

<p>Clients only send operations (Put, <code>Get</code>) to primary.</p>

<p>Primary decides <code>on order of ops</code> and forwards sequence of ops to backup.</p>

<p>Backup performs ops in same order (hot standby), Or just saves the log of operations (cold standby).</p>

<p>After backup has saved ops, primary replies to client.</p>

<h1 id="challenge">Challenge</h1>

<ol>
  <li>How to handle no-deterministic operations?</li>
  <li>What state should be transfered (operations or contents of memory) ?</li>
  <li>How to provide strong consistency (linearizability) ?</li>
  <li><code>How to handle server failures to make new primary has up-to-data state ?</code></li>
  <li>How to prevent split-brain ?</li>
</ol>

<h1 id="solutions">Solutions</h1>

<h2 id="view-service-single-point-failure">View service (single point failure)</h2>

<p><img src="https://github.com/NLGithubWP/tech-notebook/raw/master/img/a_img_store/image-20220204203014472.png" alt="image-20220204230112657" /></p>

<p>View server <code>detect failure</code>, <code>handle failure</code> and <code>manage servers</code></p>

<h3 id="basic-operation-1"><strong>basic operation</strong></h3>

<ul>
  <li>view forms a sequence in time</li>
  <li><code>detect failure</code>
    <ul>
      <li>The view service maintains role for each node</li>
      <li>Each server periodically pings (Ping RPC) view server. If n pings is missing, then the node is considered to be dead.</li>
    </ul>
  </li>
  <li><code>handle failure</code>
    <ul>
      <li>On primary failure, one backup =&gt; primary, one idle =&gt; backup (init with primaryâ€™s state), primary state transfer, view server get ack from primary and then declare a new view.</li>
      <li>On backup failure, one idle =&gt; backup, primary state transfer, view server get ack from primary and then declare a new view.</li>
    </ul>
  </li>
  <li><code>manage servers</code>
    <ul>
      <li>Any server can ping view server.</li>
      <li>view service maintain 2 server (one primary and one backup), extras are â€œidleâ€ which can be promoted to backup.</li>
    </ul>
  </li>
</ul>

<h3 id="rules-in-implementation"><strong>Rules in implementation</strong></h3>

<p>ç®€è€Œè¨€ä¹‹ï¼Œ</p>

<ol>
  <li>primary åˆšé€‰ä¸Šï¼Œè¦åš<code>state transfer</code></li>
  <li>Primaryåªèƒ½ä»backupä¸­é€‰ï¼Œ primaryåœ¨è¿”å›clientå‰ç­‰å¾…backupåŒæ­¥ã€‚</li>
  <li>Backupåªæ¥å—åŒviewçš„primaryè¯·æ±‚ï¼Œ Backupä¸æ¥å—clientçš„requestã€‚</li>
  <li>state transfer æœŸé—´ç³»ç»Ÿä¸å¯ç”¨ã€‚</li>
  <li>å‡ºé”™åï¼ŒView serverç­‰å¾…primaryçš„state transfer ç¡®è®¤æ‰æ›´æ–°æœ¬åœ°serveré›†ç¾¤roleã€‚åœ¨æ­¤ä¹‹å‰ï¼Œprimaryå’Œbackupéƒ½ä¸èƒ½è·Ÿæ–°ã€‚</li>
</ol>

<p>In detail</p>

<ol>
  <li>
    <p>Do <strong>not</strong> ask view server on every request in client side.</p>
  </li>
  <li>
    <p>View server declare a new view if and only if it receive ack from primary. And primay send ack &lt;Ping, viewNum+1&gt; to view server(with viewNum) after <code>finishing state transfer</code>.</p>

    <p><em>=&gt; <code>make sure new primary has up-to-data state</code></em></p>
  </li>
  <li>
    <p>Primary in view i+1 must have been backup or primary in view i.</p>

    <p><em>=&gt; åªèƒ½ä»backupæˆ–primaryæŒ‘é€‰æ–°çš„primaryï¼Œä¸èƒ½ä»idleä¸­é€‰ï¼Œå¦åˆ™ä¼šå¼•èµ·<code>split-brain</code></em></p>
  </li>
  <li>
    <p>Primary must wait for backup to accept/execute each op before replying to client</p>

    <p><em>=&gt; <code>strong consistency</code>, write to Primary, primary failed to send to backup, primary return to client,</em> <em>primary die, client read from backup, backup doesnâ€™t have this data.</em></p>
  </li>
  <li>
    <p>Backup must accept forwarded requests only if the view is correct</p>

    <p><em>=&gt; <code>prevent split-brain</code> eg,. backup B get request from previous primary A after A fail and B become new primary, if B accepts it and reply to A, then A can return to client. but if B also fails, C become primary, C may return different res to client</em></p>
  </li>
  <li>
    <p>Non-primary must reject client requests</p>

    <p>=&gt; <code>strong consistency.</code></p>
  </li>
  <li>
    <p>Every operation must be before or after state transfer</p>

    <p>=&gt; <code>strong consistency</code>, during state transfer, the system is unavailabe</p>

    <p><img src="https://github.com/NLGithubWP/tech-notebook/raw/master/img/a_img_store/image-20220204224732085.png" alt="image-20220204230112657" /></p>
  </li>
</ol>

<h3 id="architecture"><strong>Architecture</strong></h3>

<p><img src="https://github.com/NLGithubWP/tech-notebook/raw/master/img/a_img_store/image-20220204230112657.png" alt="image-20220204230112657" /></p>

<h1 id="project-design">Project Design</h1>

<h2 id="view-server">View Server</h2>

<p>å…³é”®ç‚¹ï¼š</p>

<ol>
  <li>æŒ‚äº†å¯ä»¥åˆ‡æ¢ï¼ˆbackup view ç›¸åŒçš„æ—¶å€™ï¼‰ï¼Œå¯ä»¥æš‚æ—¶æ”¹å˜viewï¼Œç„¶åç­‰å¾…ackã€‚</li>
  <li>åªæœ‰primaryçš„ackåˆ°äº†ï¼Œæ‰èƒ½å¢åŠ æ–°çš„backupï¼Œå¹¶ä¸”æ”¹å˜view</li>
</ol>

<p>some test case rules</p>

<ol>
  <li>viewserver init with (null, null, viewNum = 0)</li>
  <li>if primary = null(must be startup), view(0) =&gt; newView(1)</li>
  <li>if primary acked (1), backup come, view(1) =&gt; newView(2)</li>
  <li>if primary not acked (1), backup come, primary acked, view =&gt; newView(2)</li>
  <li>primary fail,
    <ul>
      <li>primary/backup at view(2) = currentView(2)</li>
      <li>primary now fail, backup =&gt; primary, view =&gt; newView(3)</li>
    </ul>
  </li>
  <li>primary fail,
    <ul>
      <li>primary/backup at view(2) = currentView(2)</li>
      <li>primary now fail, backup =&gt; primary, view =&gt; newView(3)</li>
      <li>New primary acked(3), backup come, view =&gt; newView(4)</li>
    </ul>
  </li>
  <li>primary fail,
    <ul>
      <li>primary/backup at view(2) = currentView(2)</li>
      <li>primary now fail, backup =&gt; primary, idle =&gt; backup, view =&gt; newView(3)</li>
    </ul>
  </li>
  <li>primary fail,
    <ul>
      <li>primary at view(1),</li>
      <li>backup come, view =&gt; newView(2)</li>
      <li>primary not ack(2).</li>
      <li>primary now fail, cannot use this backup. but keep it.</li>
    </ul>
  </li>
  <li>backup fail,
    <ul>
      <li>primary/backup at view(2) = currentView(2)</li>
      <li>backup now fail, remove it, view =&gt; newView(3)</li>
    </ul>
  </li>
  <li>primary fail,
    <ul>
      <li>primary/backup at view(2) = currentView(2)</li>
      <li>primary now fail, backup =&gt; primary, idle =&gt; backup, view =&gt; newView(3)</li>
      <li>New primary now fail before acked, cannot use this backup.</li>
    </ul>
  </li>
  <li>idle server fail,
    <ul>
      <li>primary registered</li>
      <li>Idle come, primary/idle fail. idle is deleted</li>
      <li>primary restart and ack, view(0) =&gt; newView(1)</li>
    </ul>
  </li>
  <li>Cc
    <ul>
      <li>primary registered</li>
      <li>primary fail, view(1) &lt;=&gt; view(1)</li>
      <li>primary acked(1)</li>
      <li><code>all server fail, view(1) &lt;=&gt; view(1)</code></li>
      <li>backup come, view =&gt; newView(2)</li>
      <li>primary restart and ack, view(2) &lt;=&gt; view(2)</li>
      <li>idles timeout, view(2) &lt;=&gt; view(2)</li>
      <li><code>all server fail, view(2) &lt;=&gt; view(2)</code></li>
    </ul>
  </li>
</ol>

:ET